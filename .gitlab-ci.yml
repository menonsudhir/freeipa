image:
  name: docker-registry.upshift.redhat.com/idm/idm-test-slave:latest
  entrypoint: [""]

.mr_template:
  tags:
  - shared
  only:
    refs:
    - merge_requests
  artifacts:
    untracked: true
    when: always
    expire_in: 1 week
  before_script:
  - git clone -b production --depth=1 https://gitlab.cee.redhat.com/identity-management/idm-ci.git
  - pip3 install ./idm-ci
  - idm-ci/scripts/fork_updater.py --metadata-file $METADATA_FILE_PATH
  - cp $METADATA_FILE_PATH /tmp/metadata.yaml
  script:
  - idm-ci/scripts/te /tmp/metadata.yaml --upto test
  after_script:
  - idm-ci/scripts/te /tmp/metadata.yaml --phase teardown
  - idm-ci/scripts/upload-artifacts.sh -p QEW/$CI_PROJECT_PATH -r $CI_PIPELINE_ID -j $CI_JOB_NAME/$CI_JOB_ID

.mr_backport_template: &mr_backport_definition
  tags:
  - shared
  only:
  - /^RHEL*/

backport-mr:
  <<: *mr_backport_definition
  before_script:
  - git clone -b production --depth=1 https://gitlab.cee.redhat.com/identity-management/idm-ci.git
  - pip3 install ./idm-ci
  script:
  - python3 idm-ci/scripts/backport_mr.py

include:
  - local: '.pytests-jobs.yml'
  - local: '.upstream-jobs.yml'
